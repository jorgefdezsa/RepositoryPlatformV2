# DEMO Repository Platform

Plataforma de integraci√≥n basada en Azure Functions (Worker aislado .NET 9) para operaciones de negocio (ej. Upsert de clientes) sobre distintos or√≠genes/destinos (Dynamics 365 / SQL) con capacidades de resiliencia (reintentos en Service Bus), validaci√≥n, mapeo y desacoplamiento por capas.

---
## üîç Objetivos
- Exponer funciones HTTP y basadas en mensajer√≠a para orquestar operaciones de dominio.
- Implementar una arquitectura limpia / DDD orientada a mantenibilidad y extensibilidad.
- Asegurar resiliencia ante fallos controlados v√≠a reintentos programados en Azure Service Bus.
- Centralizar validaci√≥n, mapeo, manejo de errores y presentaci√≥n de respuestas homog√©neas.

---
## üèóÔ∏è Arquitectura (visi√≥n alta)
```
[Cliente/Caller]
     |  HTTP POST /UpsertCustomer
     v
[Azure Function (Isolated)] --(Validation + Mapping)--> [Servicio de Dominio]
     |                                                /          \
     |                                     [Repositorios SQL]   [DataProvider D365]
     |                                                          (CDS / Dataverse)
     |-- on Controlled Error --> [Retry Manager] -> [Service Bus Topic/Queue upsertcustomer]
                                      ^                    |
                                      | (Trigger Retry) <--+
```

### Capas / Proyectos
| Proyecto | Rol principal |
|----------|---------------|
| `DEMO.API.Functions` | Funciones Azure (triggers HTTP, Service Bus), Middlewares, Presenters, Validaci√≥n y orquestaci√≥n. |
| `DEMO.API.Core` | Entidades de dominio, excepciones personalizadas, l√≥gica transversal m√≠nima. |
| `DEMO.API.D365.DataProvider` | Acceso a Dynamics 365 / Dataverse (contexto, conexi√≥n, atributos, providers). |
| `DEMO.API.D365.Data` | Modelos/DTOs y repositorios/abstracciones espec√≠ficas de D365. |
| `DEMO.API.D365.Services` | Servicios de dominio (casos de uso: Customer, etc.). |
| `DEMO.API.SQL` | Repositorios y acceso a SQL (EF Core DbContext y repos). |
| `DEMO.API.SQL.Integrations` | Modelos y repositorios de integraciones SQL auxiliares. |
| `DEMO.API.Functions.Helpers.Types` | Infraestructura auxiliar: Service Bus, Retry Manager, Parsers/Serializers, extensiones. |
| `DEMO.API.Resources` | Recursos `.resx` multilenguaje (mensajes, internacionalizaci√≥n). |
| `DEMO-REPOSITORY.ServiceDefaults` | Extensiones comunes y configuraci√≥n base compartida. |

### Principales librer√≠as / tecnolog√≠as
- .NET 9 / C# (Azure Functions Isolated Worker v4)
- Azure Service Bus (mensajer√≠a y reintentos diferidos)
- Entity Framework Core 7 (SQL Server)
- AutoMapper (mapeo DTO <-> Modelos)
- FluentValidation (validaci√≥n declarativa)
- OpenAPI (documentaci√≥n autom√°tica de endpoints)
- Inyecci√≥n de dependencias nativa (`Microsoft.Extensions.*`)
- Middleware personalizado para logging y manejo de excepciones

---
## ‚öôÔ∏è Flujo de ejemplo: `UpsertCustomer`
1. HTTP Trigger `Function("UpsertCustomer")` recibe `UpsertCustomerModel` (JSON).
2. `GetJsonBody<TModel, TValidator>()` deserializa + valida (FluentValidation). Si hay errores -> `BadRequestException`.
3. AutoMapper convierte modelo -> `UpsertCustomerRequest` (DTO de servicio).
4. `ICustomerService.Handle()` ejecuta la l√≥gica de dominio: coordinaci√≥n entre repositorios D365/SQL.
5. El resultado se materializa v√≠a un `IApiPresenter<UpsertCustomerResponse>` que encapsula formato de respuesta.
6. Si se produce una excepci√≥n controlada que requiere reintento, `IRetryManager.SendMessage()` publica el payload en Service Bus (`upsertcustomer`).
7. La funci√≥n `RetryUpsertCustomer` (ServiceBusTrigger) consume el mensaje y re-ejecuta el flujo aplicando pol√≠tica de reintentos lineal (o la configurada).

### Manejo de errores
- Excepciones de validaci√≥n -> 400 (Bad Request) con lista de mensajes.
- Concurrency / conflictos de dominio -> 409 (Conflict) (seg√∫n implementaci√≥n interna del servicio).
- Errores no controlados -> 500 (Internal Server Error) capturados por `ExceptionLoggingMiddleware` (log + respuesta estandarizada).

### Reintentos y Service Bus
El `RetryManager` gestiona:
- Env√≠o inicial a la cola / t√≥pico con metadatos (timestamp, retry count).
- Programaci√≥n (Scheduled Enqueue Time) basada en estrategia (e.g. Lineal, exponencial si se implementa).
- Re-publicaci√≥n incrementando cabeceras personalizadas y manteniendo trazabilidad.

---
## üß© Inyecci√≥n de dependencias (Program.cs resumido)
- Registro de AutoMapper (assemblies escaneados + perfiles expl√≠citos).
- Registro de clientes de Azure Service Bus (cliente y administraci√≥n) con pol√≠tica de reintentos.
- Registro de DbContext EF Core (`SqldbIberoamericaFspoDevContext`) con cadena `SQLConnectionString`.
- Encadenamiento de m√©todos de extensi√≥n: `.AddCDSDataProviderDependencies()`, `.AddRepositoriesDependencies()`, `.AddServicesDependencies()`, `.AddHelpersDependencies()`, `.AddSqlDependencies()`, `.AddPresentersInputsDependencies()`.

---
## üõ°Ô∏è Principios de dise√±o
- Separaci√≥n de responsabilidades: Cada proyecto foca un aspecto (dominio, infraestructura, aplicaci√≥n, presentaci√≥n).
- Abstracci√≥n de acceso a datos: Servicios de dominio no dependen de detalles concretos de acceso (repositorios / providers detr√°s de interfaces).
- Resiliencia y consistencia eventual mediante reintentos as√≠ncronos.
- Internacionalizaci√≥n: Mensajes en `DEMO.API.Resources` (neutral + culturas `es-ES`, `pt-PT`).
- Extensibilidad: Nuevas funciones siguen un pipeline consistente (validaci√≥n -> mapeo -> servicio -> presenter -> respuesta / retry).

---
## üöÄ Puesta en marcha local
### Prerrequisitos
- .NET 9 SDK
- Azure Functions Core Tools v4
- Azure Service Bus Namespace (cadena conexi√≥n) (local o en Azure)
- SQL Server (local o Azure) con base y esquemas esperados

### Archivos de configuraci√≥n
Crear `DEMO.API.Functions/local.settings.json` (no se versiona) con algo similar:
```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true", // si se requiere
    "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
    "ServiceBusConnection": "Endpoint=sb://<namespace>.servicebus.windows.net/;SharedAccessKeyName=...;SharedAccessKey=...",
    "SQLConnectionString": "Server=localhost;Database=DemoDb;User Id=...;Password=...;TrustServerCertificate=True;"
  }
}
```
(No incluir secretos reales en control de versiones.)

### Compilar
```powershell
dotnet restore
dotnet build
```

### Ejecutar Functions
```powershell
cd .\DEMO.API.Functions
func start
```
OpenAPI/Swagger se expondr√° (seg√∫n configuraci√≥n de la extensi√≥n) t√≠picamente en: `http://localhost:7071/api/swagger/ui`.

### Invocar UpsertCustomer (ejemplo)
```bash
POST http://localhost:7071/api/UpsertCustomer
Content-Type: application/json

{
  "customerId": "12345",
  "name": "Cliente Demo",
  "email": "demo@example.com"
}
```
(Estructura exacta depender√° del modelo `UpsertCustomerModel`.)

---
## ‚ûï A√±adir una nueva Function (gu√≠a r√°pida)
1. Modelo + Validator: Crear `MyOperationModel` y `MyOperationValidator` (FluentValidation).
2. DTO y Perfil AutoMapper: Crear request/response DTOs en capa de servicios / data y perfil de mapeo.
3. Servicio de dominio: Agregar m√©todo en servicio o nuevo servicio implementando interfaz adecuada.
4. Presenter: Implementar `IApiPresenter<T>` si el contrato de respuesta difiere.
5. Function: Crear clase con `[Function("MyOperation")]` + triggers (HTTP / ServiceBus).
6. Registrar dependencias (si nuevas) en m√©todos de extensi√≥n DI.
7. Actualizar OpenAPI con atributos (`OpenApiOperation`, `OpenApiResponseWithBody`).
8. Probar local + escenarios de error / retry.

---
## üì¶ Packaging & Deploy (resumen conceptual)
- Publicaci√≥n Azure Functions aisladas: `dotnet publish -c Release` y despliegue mediante Azure DevOps / GitHub Actions / Azure Functions Deploy.
- Asegurar configuraci√≥n de App Settings en el Function App (ServiceBusConnection, SQLConnectionString, etc.).
- (Opcional) Habilitar Application Insights para telemetr√≠a (paquete y connection string).

---
## üß™ Testing (recomendado)
Aunque no se muestran proyectos de test en este repo, se sugiere:
- Tests de Validaci√≥n: Validar reglas FluentValidation.
- Tests de Mapeo: Assert AutoMapper configuration (`MapperConfiguration.AssertConfigurationIsValid()`).
- Tests de Servicios: Mock de repositorios / providers.
- Tests de Functions: Uso de `FunctionContext` fake + serializaci√≥n de requests.

---
## üìä Logging & Observabilidad
- Consola (local) v√≠a `AddConsole()`.
- Middleware central para registro de excepciones.
- Recomendado: habilitar Application Insights (telemetr√≠a, traces, dependencias, m√©tricas custom).

---
## üåê Internacionalizaci√≥n
Los mensajes se resuelven desde `DEMO.API.Resources` permitiendo entregar errores / textos en distintos idiomas (ES, PT). Anclar cultura v√≠a configuraciones o encabezados (a implementar si procede).

---
## üîÅ Estrategias de Reintento
Implementadas v√≠a Service Bus + `IRetryManager`:
- Modo Lineal (intervalos uniformes configurables).
- Extensible para Exponencial, Backoff con jitter, etc. A√±adiendo l√≥gica en `RetryManager`.

---
## üß© Extensiones y Middlewares Clave
- `ExceptionLoggingMiddleware` captura errores no controlados y emite respuesta normalizada.
- Extensiones de `FunctionContext` para almacenar metadata: timestamps, retry count, payload original.

---
## üó∫Ô∏è Roadmap sugerido
- A√±adir capa de Tests automatizados.
- Implementar pol√≠tica de reintentos exponencial con jitter.
- Incorporar m√©tricas custom (latencia por caso de uso, tasa de reintentos exitosos).
- Seguridad: Autenticaci√≥n (JWT / AAD) en endpoints HTTP (actualmente `AuthorizationLevel.Anonymous`).
- Observabilidad avanzada: OpenTelemetry + traces distribuidos.

---
## üõ°Ô∏è Seguridad
- Evitar exponer Function Keys con permisos amplios si se activa auth nivel Function.
- Gestionar secretos en Azure Key Vault (referencias en App Settings) para cadenas de conexi√≥n.
- Limitar pol√≠ticas SAS de Service Bus a m√≠nimos privilegios.

---
## üìÇ Estructura (resumen)
```
DEMO-REPOSITORY.sln
‚îî‚îÄ‚îÄ DEMO.API.Functions
    ‚îú‚îÄ‚îÄ Program.cs
    ‚îú‚îÄ‚îÄ UpsertCustomer.cs
    ‚îú‚îÄ‚îÄ Middlewares/
    ‚îú‚îÄ‚îÄ Validators/
    ‚îú‚îÄ‚îÄ Presenters/
    ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ DEMO.API.Core
‚îî‚îÄ‚îÄ DEMO.API.D365.* (DataProvider, Data, Services)
‚îî‚îÄ‚îÄ DEMO.API.SQL.* (principal, Integrations)
‚îî‚îÄ‚îÄ DEMO.API.Functions.Helpers.Types
‚îî‚îÄ‚îÄ DEMO.API.Resources
‚îî‚îÄ‚îÄ DEMO-REPOSITORY.ServiceDefaults
```

---
## ‚ùì FAQ R√°pido
**¬øD√≥nde agrego un nuevo servicio de dominio?** En `DEMO.API.D365.Services` (o crear nueva carpeta seg√∫n bounded context) exponiendo interfaz + implementaci√≥n.

**¬øC√≥mo manejo nuevos mensajes de retry?** A√±adir estrategia en `RetryManager` y ajustar enumeraciones / configuraci√≥n.

**¬øC√≥mo amplio OpenAPI?** A√±adir atributos `OpenApi*` en la Function; regenerado en runtime.

---
## üìÑ Licencia
Definir licencia (MIT / Propietaria) seg√∫n pol√≠tica del repositorio.

---
## ü§ù Contribuciones
1. Crear rama feature/*.
2. PR con descripci√≥n t√©cnica + capturas (si aplica).
3. Revisiones: Est√°ndares de naming, separaci√≥n de capas, no exponer secretos.

---
## ‚úÖ Resumen
Este README cubre la arquitectura, flujo principal, configuraci√≥n, extensibilidad y mejores pr√°cticas recomendadas para evolucionar la plataforma.
